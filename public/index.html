<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoxDrop – Anonymous Voice Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=jQZ2zCoV"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; }
    .mic-btn-active { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
  </style>
</head>
<body class="min-h-screen">
<div id="app">

  <!-- Auth Screen -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-gray-800/50 backdrop-blur-xl rounded-3xl p-8 border border-gray-700">
        <h1 class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent mb-2">VoxDrop</h1>
        <p class="text-gray-400 mb-8">Your anonymous voice box</p>

        <div class="flex gap-4 mb-8 border-b border-gray-700">
          <button onclick="switchAuthTab('login')" id="loginTab" class="pb-4 font-bold border-b-2 border-pink-500 text-white">Login</button>
          <button onclick="switchAuthTab('register')" id="registerTab" class="pb-4 font-bold text-gray-400 border-b-2 border-transparent">Create Account</button>
        </div>

        <div id="loginForm" class="space-y-4">
          <input id="loginUsername" placeholder="Username" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="loginPassword" type="password" placeholder="Password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <button onclick="login()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 rounded-lg font-bold text-lg">Login</button>
        </div>

        <div id="registerForm" class="space-y-4 hidden">
          <input id="regUsername" placeholder="Choose username" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="regPassword" type="password" placeholder="Password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="regPassword2" type="password" placeholder="Confirm password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <button onclick="register()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-lg font-bold text-lg">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden min-h-screen">
    <div class="bg-gray-800/50 backdrop-blur-xl border-b border-gray-700 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent">VoxDrop</h1>
          <p id="userDisplay" class="text-sm text-gray-400"></p>
        </div>
        <div class="flex gap-4 items-center">
          <button onclick="showTab('inbox')" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">Inbox</button>
          <button onclick="showTab('share')" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">My Link</button>
          <button onclick="showTab('settings')" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">Settings</button>
          <button onclick="logout()" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-semibold">Logout</button>
        </div>
      </div>
    </div>

    <!-- Inbox -->
    <div id="inboxTab" class="max-w-7xl mx-auto p-6">
      <h2 class="text-4xl font-bold mb-8">Your Voice Box</h2>
      <div id="messagesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="emptyState" class="text-center py-16">
        <p class="text-2xl text-gray-400">No drops yet</p>
        <p class="text-gray-500 mt-2">Share your link to receive anonymous voice messages</p>
      </div>
    </div>

    <!-- Share Page -->
    <div id="shareTab" class="hidden max-w-7xl mx-auto p-6">

    <!-- Settings Page -->
    <div id="settingsTab" class="hidden max-w-7xl mx-auto p-6">
      <h2 class="text-4xl font-bold mb-8">Settings</h2>
      <div class="max-w-2xl">
        <div class="bg-gray-800/50 rounded-2xl p-8 border border-gray-700">
          <h3 class="text-2xl font-bold mb-6">Voice Settings</h3>
          
          <div class="bg-gray-900/50 rounded-lg p-6 border border-gray-700">
            <h4 class="font-bold mb-3 text-green-400">✅ Using Free ResponsiveVoice API</h4>
            <p class="text-gray-300 mb-3">
              VoxDrop uses ResponsiveVoice's free Text-to-Speech API. No API keys needed!
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-300 text-sm">
              <li>Completely free to use</li>
              <li>High-quality voices</li>
              <li>Multiple accents and languages</li>
              <li>No sign-ups required</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Page -->
    <div id="shareTab" class="hidden max-w-7xl mx-auto p-6">
      <h2 class="text-5xl font-black mb-10 text-center bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent">
        Share Your Anonymous Voice Box
      </h2>
      <div class="max-w-2xl mx-auto">
        <div class="bg-gray-800/60 backdrop-blur-xl rounded-3xl p-10 border border-gray-700 shadow-2xl">
          <p class="text-gray-300 text-center mb-8 text-lg">
            Anyone with this link can send you a secret voice message.<br>No account needed.
          </p>

          <div class="flex gap-4 mb-8">
            <input id="shareUrl" readonly class="flex-1 px-6 py-4 bg-gray-900/80 border border-gray-600 rounded-2xl text-white font-mono text-center text-lg tracking-wider">
            <button onclick="copyShareLink()" class="px-10 py-4 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 rounded-2xl font-bold text-lg shadow-lg hover:scale-105 transition">
              Copy Link
            </button>
          </div>

          <div class="flex justify-center mb-10">
            <div id="qrCanvas"></div>
          </div>

          <p class="text-center text-gray-400 mb-6">Share directly</p>
          <div class="grid grid-cols-3 gap-4">
            <button onclick="shareToWhatsApp()" class="flex items-center justify-center gap-3 py-4 bg-green-600 hover:bg-green-700 rounded-2xl font-bold transition hover:scale-105">
              WhatsApp
            </button>
            <button onclick="shareToInstagram()" class="py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-2xl font-bold transition hover:scale-105">
              Instagram
            </button>
            <button onclick="shareToTikTok()" class="py-4 bg-black hover:bg-gray-800 rounded-2xl font-bold transition hover:scale-105">
              TikTok
            </button>
          </div>

          <div class="mt-10 text-center">
            <p class="text-3xl text-gray-400">Total drops received</p>
            <p id="totalDrops" class="text-6xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent mt-4">0</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recording Screen -->
  <div id="recordingTab" class="hidden min-h-screen flex items-center justify-center p-6">
    <div class="max-w-2xl w-full">
      <h2 class="text-4xl font-bold text-center mb-2">Drop a voice to</h2>
      <p class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent text-center mb-8" id="targetName"></p>

      <div class="bg-gray-800/50 rounded-2xl p-8 border border-gray-700 space-y-6">
        <div>
          <label class="block text-gray-300 mb-3 font-semibold">Avatar</label>
          <select id="character" class="w-full p-4 rounded-lg bg-gray-700 text-white">
            <option value="0">Blue Robot</option>
            <option value="1">Pink Alien</option>
            <option value="2">Green Monster</option>
            <option value="3">Yellow Blob</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-300 mb-3 font-semibold">Voice</label>
          <select id="voiceSelect" class="w-full p-4 rounded-lg bg-gray-700 text-white">
            <option value="UK English Female">UK English Female</option>
            <option value="UK English Male">UK English Male</option>
            <option value="US English Female" selected>US English Female</option>
            <option value="US English Male">US English Male</option>
            <option value="Australian Female">Australian Female</option>
            <option value="Australian Male">Australian Male</option>
            <option value="French Female">French Female</option>
            <option value="German Female">German Female</option>
            <option value="Spanish Female">Spanish Female</option>
            <option value="Italian Female">Italian Female</option>
          </select>
          <p class="text-xs text-gray-400 mt-2">Using ResponsiveVoice (100% free!)</p>
        </div>

        <canvas id="canvas" width="300" height="400" class="mx-auto bg-gray-900 rounded-xl shadow-2xl border-2 border-gray-700"></canvas>

        <div class="flex flex-col items-center gap-4">
          <button id="micBtn" class="w-32 h-32 bg-gradient-to-r from-pink-600 to-red-600 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition">
            <svg class="w-16 h-16" fill="white" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3s-3 1.34-3 3v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
          </button>
          <p id="status" class="text-lg text-gray-300 font-semibold">Click to record</p>
        </div>

        <button onclick="goHome()" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 rounded-lg font-bold text-lg">
          Get Your Own Box
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Unlock audio on first interaction
  document.addEventListener('click', function() {
    const ctx = new AudioContext();
    ctx.resume();
  }, { once: true });

  let currentUser = null;
  let targetUsername = null;
  let isRecording = false;
  let recognition = null;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const characters = [
    { color: "#60a5fa", eyeY: -30 },
    { color: "#f472b6", eyeY: -25 },
    { color: "#34d399", eyeY: -35 },
    { color: "#fbbf24", eyeY: -20 }
  ];

  function draw(vol) {
    vol = vol || 0;
    const charSelect = document.getElementById('character');
    const charIndex = charSelect ? parseInt(charSelect.value) : 0;
    const c = characters[charIndex];
    
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, 300, 400);
    const s = 1 + vol * 0.3;
    ctx.save();
    ctx.translate(150, 200);
    ctx.scale(s, s);
    ctx.beginPath();
    ctx.arc(0, 0, 90, 0, Math.PI * 2);
    ctx.fillStyle = c.color;
    ctx.fill();
    ctx.fillStyle = 'white';
    
    ctx.beginPath();
    ctx.arc(-35, c.eyeY, 20, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(35, c.eyeY, 20, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(-35, c.eyeY, 10, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(35, c.eyeY, 10, 0, Math.PI * 2);
    ctx.fill();
    
    const mouth = 5 + vol * 70;
    ctx.beginPath();
    ctx.ellipse(0, 40, 50, mouth, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  let vol = 0;
  function animate() {
    draw(vol);
    vol *= 0.93;
    requestAnimationFrame(animate);
  }
  animate();

  function initRec() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = 'en-US';
    r.continuous = false;
    return r;
  }
  recognition = initRec();

  // Storage functions
  function getUsers() {
    const users = localStorage.getItem('voxdrop_users');
    return users ? JSON.parse(users) : {};
  }

  function saveUsers(users) {
    localStorage.setItem('voxdrop_users', JSON.stringify(users));
  }

  function getInbox(username) {
    const inbox = localStorage.getItem('voxdrop_inbox_' + username);
    return inbox ? JSON.parse(inbox) : [];
  }

  function saveInbox(username, messages) {
    localStorage.setItem('voxdrop_inbox_' + username, JSON.stringify(messages));
  }

  function switchAuthTab(t) {
    const tabs = ['login', 'register'];
    tabs.forEach(function(x) {
      const form = document.getElementById(x + 'Form');
      const tab = document.getElementById(x + 'Tab');
      
      if (t !== x) {
        form.classList.add('hidden');
        tab.classList.remove('text-white', 'border-pink-500');
        tab.classList.add('text-gray-400', 'border-transparent');
      } else {
        form.classList.remove('hidden');
        tab.classList.add('text-white', 'border-pink-500');
        tab.classList.remove('text-gray-400', 'border-transparent');
      }
    });
  }

  function login() {
    const u = document.getElementById('loginUsername').value.trim();
    const p = document.getElementById('loginPassword').value;
    if (!u || !p) {
      alert('Please fill all fields');
      return;
    }
    
    const users = getUsers();
    if (users[u] && users[u] === p) {
      currentUser = u;
      localStorage.setItem('voxdrop_currentUser', u);
      showLoggedIn();
    } else {
      alert('Invalid username or password');
    }
  }

  function register() {
    const u = document.getElementById('regUsername').value.trim();
    const p = document.getElementById('regPassword').value;
    const p2 = document.getElementById('regPassword2').value;
    
    if (!u || !p) {
      alert('Please fill all fields');
      return;
    }
    if (p !== p2) {
      alert('Passwords do not match');
      return;
    }
    
    const users = getUsers();
    if (users[u]) {
      alert('Username already exists');
      return;
    }
    
    users[u] = p;
    saveUsers(users);
    currentUser = u;
    localStorage.setItem('voxdrop_currentUser', u);
    showLoggedIn();
  }

  function logout() {
    localStorage.removeItem('voxdrop_currentUser');
    location.reload();
  }

  function showLoggedIn() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userDisplay').textContent = '@' + currentUser;
    document.getElementById('shareUrl').value = location.origin + location.pathname + '#@' + currentUser;
    showTab('inbox');
  }

  function showTab(tab) {
    document.getElementById('inboxTab').classList.add('hidden');
    document.getElementById('shareTab').classList.add('hidden');
    document.getElementById('settingsTab').classList.add('hidden');
    document.getElementById(tab + 'Tab').classList.remove('hidden');
    if (tab === 'inbox') loadInbox();
    if (tab === 'share') updateSharePage();
    if (tab === 'settings') loadSettings();
  }

  function loadSettings() {
    // Settings page now just shows info about the free ResponsiveVoice API
  }

  function saveApiKey() {
    // No longer needed with ResponsiveVoice
  }

  function getSpeechifyApiKey() {
    // No longer needed
    return null;
  }

  // No need to load voices dynamically with ResponsiveVoice

  function updateSharePage() {
    const url = location.origin + location.pathname + '#@' + currentUser;
    document.getElementById('shareUrl').value = url;
    
    const qrDiv = document.getElementById('qrCanvas');
    qrDiv.innerHTML = '';
    new QRCode(qrDiv, { 
      text: url, 
      width: 200, 
      height: 200, 
      colorDark: "#f472b6", 
      colorLight: "#1e293b" 
    });
    
    const msgs = getInbox(currentUser);
    document.getElementById('totalDrops').textContent = msgs.length;
  }

  function copyShareLink() {
    const url = document.getElementById('shareUrl').value;
    navigator.clipboard.writeText(url);
    alert('Link copied to clipboard!');
  }

  function shareToWhatsApp() {
    const url = document.getElementById('shareUrl').value;
    window.open('https://wa.me/?text=Send%20me%20a%20secret%20voice%20drop%21%20' + encodeURIComponent(url));
  }

  function shareToInstagram() {
    const url = document.getElementById('shareUrl').value;
    navigator.clipboard.writeText(url);
    alert('Link copied! Paste it in your Instagram bio or story');
  }

  function shareToTikTok() {
    const url = document.getElementById('shareUrl').value;
    navigator.clipboard.writeText(url);
    alert('Link copied! Paste it in your TikTok bio');
  }

  function loadInbox() {
    const msgs = getInbox(currentUser);
    const list = document.getElementById('messagesList');
    const empty = document.getElementById('emptyState');
    
    if (msgs.length === 0) {
      list.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    
    empty.classList.add('hidden');
    list.innerHTML = msgs.map(function(m) {
      return '<div class="bg-gray-800/50 rounded-2xl overflow-hidden border border-gray-700 hover:border-pink-500 transition">' +
        '<video controls class="w-full aspect-video bg-black"><source src="' + m.videoUrl + '" type="video/webm"></video>' +
        '<div class="p-6">' +
        (m.transcript ? '<p class="text-gray-300 italic mb-4">"' + m.transcript + '"</p>' : '') +
        '<p class="text-xs text-gray-500">' + new Date(m.date).toLocaleString() + '</p>' +
        '</div></div>';
    }).join('');
  }

  function goHome() {
    location.href = location.pathname;
  }

  // Page load
  window.onload = function() {
    const hash = location.hash;
    if (hash.startsWith('#@')) {
      targetUsername = hash.slice(2);
      document.getElementById('targetName').textContent = '@' + targetUsername;
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('recordingTab').classList.remove('hidden');
    } else {
      const saved = localStorage.getItem('voxdrop_currentUser');
      if (saved) {
        currentUser = saved;
        showLoggedIn();
      }
    }
  };

  // RECORDING
  document.getElementById('micBtn').onclick = async function() {
    if (isRecording) return;
    isRecording = true;
    const btn = document.getElementById('micBtn');
    const status = document.getElementById('status');
    btn.classList.add('mic-btn-active');
    status.textContent = "Listening...";

    let text = "";
    if (recognition) {
      text = await new Promise(function(res) {
        recognition.onresult = function(e) {
          res(e.results[0][0].transcript);
        };
        recognition.onerror = function() {
          res("");
        };
        recognition.onend = function() {
          if (!text) res("");
        };
        recognition.start();
      });
    }
    
    if (!text.trim()) {
      text = prompt("Type or say your message:") || "";
    }
    
    if (!text.trim()) {
      isRecording = false;
      btn.classList.remove('mic-btn-active');
      status.textContent = "Click to record";
      return;
    }

    status.textContent = "Speaking...";
    const videoBlob = await createVideoWithSpeechify(text.trim());

    status.textContent = "Sending...";
    await sendVideo(videoBlob, text);

    isRecording = false;
    btn.classList.remove('mic-btn-active');
    status.textContent = "Click to record";
  };

  async function createVideoWithSpeechify(text) {
    return new Promise(function(resolve, reject) {
      if (!window.responsiveVoice) {
        alert('Voice service not loaded. Please refresh the page.');
        reject(new Error('ResponsiveVoice not loaded'));
        return;
      }

      const voiceSelect = document.getElementById('voiceSelect');
      const selectedVoice = voiceSelect.value;

      // Create an audio element to capture ResponsiveVoice output
      const audioElement = new Audio();
      
      // Get the audio URL from ResponsiveVoice
      responsiveVoice.speak(text, selectedVoice, {
        onstart: function() {
          // Start recording when speech begins
          startRecording();
        },
        onend: function() {
          // Stop recording when speech ends
          setTimeout(function() {
            stopRecording();
          }, 500);
        },
        onerror: function(e) {
          alert('Error generating speech');
          reject(e);
        }
      });

      let recorder;
      let chunks = [];
      let interval;

      function startRecording() {
        // Create a MediaStream from canvas
        const canvasStream = canvas.captureStream(30);
        
        // Create oscillator for audio (since ResponsiveVoice plays through speakers)
        const audioCtx = new AudioContext();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        // We'll capture system audio by requesting microphone
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function(micStream) {
          const dest = audioCtx.createMediaStreamDestination();
          const micSource = audioCtx.createMediaStreamSource(micStream);
          micSource.connect(dest);

          const mixed = new MediaStream([
            canvasStream.getVideoTracks()[0],
            dest.stream.getAudioTracks()[0]
          ]);

          const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus') ? 
            'video/webm;codecs=vp9,opus' : 'video/webm';
          recorder = new MediaRecorder(mixed, { mimeType: mime });
          
          recorder.ondataavailable = function(e) {
            if (e.data.size) chunks.push(e.data);
          };
          
          recorder.onstop = function() {
            micStream.getTracks().forEach(track => track.stop());
            const blob = new Blob(chunks, { type: mime });
            resolve(blob);
          };

          interval = setInterval(function() {
            vol = Math.random() * 0.7 + 0.3;
          }, 100);

          recorder.start();
        }).catch(function(err) {
          alert('Please allow microphone access to record the voice message');
          reject(err);
        });
      }

      function stopRecording() {
        clearInterval(interval);
        if (recorder && recorder.state !== 'inactive') {
          recorder.stop();
        }
      }
    });
  }

  async function sendVideo(blob, text) {
    const reader = new FileReader();
    reader.onloadend = function() {
      const dataUrl = reader.result;
      const msgs = getInbox(targetUsername);
      msgs.push({
        videoUrl: dataUrl,
        transcript: text,
        date: new Date().toISOString()
      });
      saveInbox(targetUsername, msgs);
      
      confetti({ particleCount: 200, spread: 80 });
      alert("Drop sent successfully!");
      setTimeout(function() {
        location.href = location.pathname;
      }, 1200);
    };
    reader.readAsDataURL(blob);
  }
</script>
</body>
</html>
