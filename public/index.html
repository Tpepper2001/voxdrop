<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoxDrop â€“ Your Anonymous Voice Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Puter.js = real working audio everywhere -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; }
    .mic-btn-active { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 0 rgba(239, 68, 68, 0); } }
  </style>
</head>
<body class="min-h-screen">
<div id="app">

  <!-- Auth Screen -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="bg-gray-800/50 backdrop-blur-xl rounded-3xl p-8 border border-gray-700">
        <h1 class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent mb-2">VoxDrop</h1>
        <p class="text-gray-400 mb-8">Your anonymous voice box</p>

        <div class="flex gap-4 mb-8 border-b border-gray-700">
          <button onclick="switchAuthTab('login')" id="loginTab" class="pb-4 font-bold border-b-2 border-pink-500 text-white">Login</button>
          <button onclick="switchAuthTab('register')" id="registerTab" class="pb-4 font-bold text-gray-400 border-b-2 border-transparent">Create Account</button>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="space-y-4">
          <input id="loginUsername" type="text" placeholder="Username" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="loginPassword" type="password" placeholder="Password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <button onclick="login()" class="w-full py-4 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 rounded-lg font-bold text-lg">Login</button>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="space-y-4 hidden">
          <input id="regUsername" type="text" placeholder="Choose username" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="regPassword" type="password" placeholder="Password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <input id="regPassword2" type="password" placeholder="Confirm password" class="w-full p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500">
          <button onclick="register()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-lg font-bold text-lg">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (Inbox + Share) -->
  <div id="mainApp" class="hidden min-h-screen">
    <div class="bg-gray-800/50 backdrop-blur-xl border-b border-gray-700 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent">VoxDrop</h1>
          <p id="userDisplay" class="text-sm text-gray-400"></p>
        </div>
        <div class="flex gap-4 items-center">
          <button onclick="showTab('inbox')" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">Inbox</button>
          <button onclick="showTab('share')" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">My Link</button>
          <button onclick="logout()" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-semibold">Logout</button>
        </div>
      </div>
    </div>

    <div id="inboxTab" class="max-w-7xl mx-auto p-6">
      <h2 class="text-4xl font-bold mb-8">Your Voice Box</h2>
      <div id="messagesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="emptyState" class="text-center py-16 hidden">
        <p class="text-2xl text-gray-400">No drops yet</p>
        <p class="text-gray-500 mt-2">Share your link to receive anonymous voice messages</p>
      </div>
    </div>

    </div>

    <div id="shareTab" class="hidden max-w-7xl mx-auto p-6">
      <h2 class="text-4xl font-bold mb-8">Share Your Link</h2>
      <div class="bg-gray-800/50 rounded-2xl p-8 border border-gray-700 max-w-2xl">
        <p class="text-gray-400 mb-4">Anyone with this link can send you anonymous voice drops:</p>
        <div class="flex gap-3 mb-6">
          <input id="shareUrl" readonly class="flex-1 p-4 rounded-lg bg-gray-700 text-white font-mono text-lg">
          <button onclick="copyShareLink()" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 rounded-lg font-bold">Copy</button>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <button onclick="shareToWhatsApp()" class="py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold flex items-center justify-center gap-2">
            WhatsApp
          </button>
          <button onclick="shareToInstagram()" class="py-3 bg-pink-600 hover:bg-pink-700 rounded-lg font-semibold">Instagram</button>
          <button onclick="shareToTikTok()" class="py-3 bg-black hover:bg-gray-900 rounded-lg font-semibold">TikTok</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recording Screen (/@username) -->
  <div id="recordingTab" class="hidden min-h-screen flex items-center justify-center p-6">
    <div class="max-w-2xl w-full">
      <h2 class="text-4xl font-bold text-center mb-2">Drop a voice to</h2>
      <p class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent text-center mb-8" id="targetName"></p>

      <div class="bg-gray-800/50 rounded-2xl p-8 border border-gray-700 space-y-6">
        <div>
          <label class="block text-gray-300 mb-3 font-semibold">Avatar</label>
          <select id="character" class="w-full p-4 rounded-lg bg-gray-700 text-white">
            <option value="0">Blue Robot</option>
            <option value="1">Pink Alien</option>
            <option value="2">Green Monster</option>
            <option value="3">Yellow Blob</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-300 mb-3 font-semibold">Voice (Puter.js)</label>
          <select id="voiceSelect" class="w-full p-4 rounded-lg bg-gray-700 text-white">
            <option value="alloy">Alloy (OpenAI)</option>
            <option value="echo">Echo</option>
            <option value="fable">Fable</option>
            <option value="onyx">Onyx</option>
            <option value="nova">Nova</option>
            <option value="shimmer">Shimmer</option>
            <option value="female" selected>Female (Natural)</option>
            <option value="male">Male</option>
          </select>
        </div>

        <canvas id="canvas" width="300" height="400" class="mx-auto bg-gray-900 rounded-xl shadow-2xl border-2 border-gray-700"></canvas>

        <div class="flex flex-col items-center gap-4">
          <button id="micBtn" class="w-32 h-32 bg-gradient-to-r from-pink-600 to-red-600 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition">
            <svg class="w-16 h-16" fill="white" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3s-3 1.34-3 3v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
          </button>
          <p id="status" class="text-lg text-gray-300 font-semibold">Click to record</p>
        </div>

        <button onclick="location.href='/'" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 rounded-lg font-bold text-lg">
          Get Your Own Box
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Unlock audio on first tap (iOS requirement)
  const unlock = () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (ctx.state === 'suspended') ctx.resume();
    document.removeEventListener('click', unlock);
    document.removeEventListener('touchstart', unlock);
  };
  document.addEventListener('click', unlock);
  document.addEventListener('touchstart', unlock);

  let currentUser = null;
  let targetUsername = null;
  let isRecording = false;
  let recognition = null;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const characters = [
    { color: "#60a5fa", eyeY: -30 },
    { color: "#f472b6", eyeY: -25 },
    { color: "#34d399", eyeY: -35 },
    { color: "#fbbf24", eyeY: -20 }
  ];

  function draw(volume = 0) {
    const char = characters[document.getElementById('character')?.value || 0];
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, 300, 400);
    const scale = 1 + volume * 0.3;
    ctx.save();
    ctx.translate(150, 200);
    ctx.scale(scale, scale);
    ctx.beginPath(); ctx.arc(0, 0, 90, 0, Math.PI*2); ctx.fillStyle = char.color; ctx.fill();
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'black';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    const mouth = 5 + volume * 70;
    ctx.beginPath(); ctx.ellipse(0, 40, 50, mouth, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  let vol = 0;
  function animate() {
    draw(vol);
    vol *= 0.93;
    requestAnimationFrame(animate);
  }
  draw(); animate();

  // Speech Recognition
  function initRec() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.lang = 'en-US';
    r.continuous = false;
    r.interimResults = false;
    return r;
  }

  // Auth Tabs
  function switchAuthTab(mode) {
    const login = document.getElementById('loginForm');
    const reg = document.getElementById('registerForm');
    const lt = document.getElementById('loginTab');
    const rt = document.getElementById('registerTab');

    if (mode === 'login') {
      login.classList.remove('hidden');
      reg.classList.add('hidden');
      lt.classList.add('text-white', 'border-pink-500');
      lt.classList.remove('text-gray-400');
      rt.classList.remove('border-pink-500');
      rt.classList.add('text-gray-400');
    } else {
      login.classList.add('hidden');
      reg.classList.remove('hidden');
      rt.classList.add('text-white', 'border-pink-500');
      rt.classList.remove('text-gray-400');
      lt.classList.remove('border-pink-500');
      lt.classList.add('text-gray-400');
    }
  }

  async function login() {
    const u = document.getElementById('loginUsername').value.trim();
    const p = document.getElementById('loginPassword').value;
    if (!u || !p) return alert('Fill all fields');
    const res = await fetch('/api/login', {method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
    if (res.ok) {
      currentUser = u;
      localStorage.setItem('currentUser', u);
      showLoggedIn();
    } else alert('Wrong credentials');
  }

  async function register() {
    const u = document.getElementById('regUsername').value.trim();
    const p = document.getElementById('regPassword').value;
    const p2 = document.getElementById('regPassword2').value;
    if (!u || !p) return alert('Fill all fields');
    if (p !== p2) return alert('Passwords do not match');
    const res = await fetch('/api/register', {method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
    if (res.ok) {
      currentUser = u;
      localStorage.setItem('currentUser', u);
      showLoggedIn();
    } else {
      const err = await res.json();
      alert(err.error || 'Cannot create account');
    }
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
  }

  function showLoggedIn() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userDisplay').textContent = '@' + currentUser;
    document.getElementById('shareUrl').value = location.origin + '/@' + currentUser;
    showTab('inbox');
  }

  function showTab(tab) {
    document.getElementById('inboxTab').classList.add('hidden');
    document.getElementById('shareTab').classList.add('hidden');
    document.getElementById(tab + 'Tab').classList.remove('hidden');
    if (tab === 'inbox') loadInbox();
  }

  function copyShareLink() {
    navigator.clipboard.writeText(document.getElementById('shareUrl').value);
    alert('Link copied!');
  }

  function shareToWhatsApp() {
    const url = document.getElementById('shareUrl').value;
    window.open(`https://wa.me/?text=Send%20me%20an%20anonymous%20voice%20drop%21%20${encodeURIComponent(url)}`, '_blank');
  }
  function shareToInstagram() { navigator.clipboard.writeText(document.getElementById('shareUrl').value); alert('Link copied!'); }
  function shareToTikTok() { navigator.clipboard.writeText(document.getElementById('shareUrl').value); alert('Link copied!'); }

  async function loadInbox() {
    const res = await fetch('/api/inbox/' + currentUser);
    const msgs = await res.json();
    const list = document.getElementById('messagesList');
    const empty = document.getElementById('emptyState');
    if (msgs.length === 0) { list.innerHTML = ''; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    list.innerHTML = msgs.map(m => `
      <div class="bg-gray-800/50 rounded-2xl overflow-hidden border border-gray-700 hover:border-pink-500 transition">
        <video controls class="w-full aspect-video bg-black">
          <source src="${m.videoUrl}" type="video/webm">
        </video>
        <div class="p-6">
          ${m.transcript ? `<p class="text-gray-300 italic mb-4">"${m.transcript}"</p>` : ''}
          <p class="text-xs text-gray-500">${new Date(m.date).toLocaleString()}</p>
          <div class="grid grid-cols-3 gap-2 mt-4">
            <button onclick="shareVideo('${m.videoUrl}')" class="py-2 bg-green-600 hover:bg-green-700 rounded text-sm font-bold">WhatsApp</button>
            <button onclick="shareVideo('${m.videoUrl}')" class="py-2 bg-pink-600 hover:bg-pink-700 rounded text-sm font-bold">Instagram</button>
            <a href="${m.videoUrl}" download class="py-2 bg-blue-600 hover:bg-blue-700 rounded text-center text-sm font-bold">Download</a>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function shareVideo(url) {
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const file = new File([blob], "voxdrop.webm", {type: "video/webm"});
      if (navigator.canShare && navigator.canShare({files: [file]})) {
        await navigator.share({files: [file], title: "Voice Drop"});
      } else throw 0;
    } catch {
      navigator.clipboard.writeText(url);
      alert("Link copied to clipboard!");
    }
  }

  // On page load
  window.onload = () => {
    const path = location.pathname;
    if (path.startsWith('/@')) {
      targetUsername = path.slice(2);
      document.getElementById('targetName').textContent = '@' + targetUsername;
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('recordingTab').classList.remove('hidden');
      recognition = initRec();
    } else if (localStorage.getItem('currentUser')) {
      currentUser = localStorage.getItem('currentUser');
      showLoggedIn();
    }
  };

  // RECORDING WITH REAL AUDIO (Puter.js)
  document.getElementById('micBtn').onclick = async () => {
    if (isRecording) return;
    isRecording = true;
    document.getElementById('micBtn').classList.add('mic-btn-active');
    document.getElementById('status').textContent = "Listening...";

    let transcript = "";

    if (recognition) {
      transcript = await new Promise((resolve) => {
        recognition.onresult = e => resolve(e.results[0][0].transcript);
        recognition.onerror = () => resolve("");
        recognition.onend = () => resolve(transcript);
        recognition.start();
      });
    }

    if (!transcript.trim()) {
      transcript = prompt("Say or type your message:") || "";
    }

    if (!transcript.trim()) {
      isRecording = false;
      document.getElementById('micBtn').classList.remove('mic-btn-active');
      document.getElementById('status').textContent = "Click to record";
      return;
    }

    document.getElementById('status').textContent = "Creating video...";
    const videoBlob = await createVideoWithPuterTTS(transcript.trim());

    document.getElementById('status').textContent = "Sending...";
    await send(videoBlob, transcript);

    isRecording = false;
    document.getElementById('micBtn').classList.remove('mic-btn-active');
    document.getElementById('status').textContent = "Click to record";
  };

  async function createVideoWithPuterTTS(text) {
    return new Promise(async resolve => {
      const voice = document.getElementById('voiceSelect').value;

      // 1. Get real audio from Puter.js
      const audioBlob = await puter.ai.tts(text, { voice });
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);

      // 2. Canvas stream
      const canvasStream = canvas.captureStream(30);

      // 3. Mix canvas + real audio
      const actx = new AudioContext();
      const source = actx.createMediaElementSource(audio);
      const dest = actx.createMediaStreamDestination();
      source.connect(dest);
      source.connect(actx.destination);

      const mixed = new MediaStream([
        canvasStream.getVideoTracks()[0],
        dest.stream.getAudioTracks()[0]
      ]);

      const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus') ? 'video/webm;codecs=vp9,opus' : 'video/webm';
      const recorder = new MediaRecorder(mixed, {mimeType: mime});
      const chunks = [];

      recorder.ondataavailable = e => e.data.size && chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, {type: mime});
        URL.revokeObjectURL(audioUrl);
        resolve(blob);
      };

      let mouth;
      audio.onplay = () => {
        mouth = setInterval(() => vol = Math.random()*0.7 + 0.3, 100);
        recorder.start();
      };
      audio.onended = () => {
        clearInterval(mouth);
        setTimeout(() => recorder.stop(), 800);
      };

      audio.play();
    });
  }

  async function send(blob, text) {
    const form = new FormData();
    form.append('video', blob, 'drop.webm');
    form.append('transcript', text);

    const res = await fetch(`/api/receive/${targetUsername}`, {method: 'POST', body: form});
    if (res.ok) {
      confetti({particleCount: 200, spread: 80});
      alert("Drop sent!");
      setTimeout(() => location.href = '/', 1200);
    } else alert("Send failed");
  }
</script>
</body>
</html>
