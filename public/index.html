<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoxDrop – Your Anonymous Voice Box</title>
  <meta property="og:title" content="You got a VoxDrop!" />
  <meta property="og:description" content="Someone sent you an anonymous animated voice message. Click to listen → Record your reply → Get your own box!" />
  <meta name="twitter:card" content="player" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.build@1.0.0/lib/qrcode.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; }
    .mic-btn-active { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
  </style>
</head>
<body class="min-h-screen">

<div id="app" class="max-w-lg mx-auto p-6 text-center">

  <!-- 1. Landing / Register / Login -->
  <div id="landing" class="space-y-10">
    <h1 class="text-6xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent">VoxDrop</h1>
    <p class="text-xl text-gray-300">Get your own anonymous voice box.<br>People drop you animated voice notes.</p>

    <div class="space-y-4">
      <input id="regUsername" placeholder="Choose username" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <input id="regEmail" type="email" placeholder="Email (optional)" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <input id="regPassword" type="password" placeholder="Password" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <button onclick="register()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-xl shadow-lg">Create My Voice Box</button>
    </div>

    <div class="text-gray-400">
      Already have one? <button onclick="showLogin()" class="text-blue-400 underline font-bold">Log in</button>
    </div>
  </div>

  <!-- 2. Login Screen -->
  <div id="loginScreen" class="hidden space-y-10">
    <h2 class="text-4xl font-bold">Welcome back!</h2>
    <div class="space-y-4">
      <input id="loginUsername" placeholder="Username" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <input id="loginPassword" type="password" placeholder="Password" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <button onclick="login()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold text-xl">Log In</button>
    </div>
    <button onclick="showLanding()" class="text-gray-400 underline">← Back</button>
  </div>

  <!-- 3. Your Permanent Link (after register/login) -->
  <div id="myLink" class="hidden space-y-10">
    <h2 class="text-5xl font-bold bg-gradient-to-r from-green-400 to-cyan-400 bg-clip-text text-transparent">Your VoxBox is Ready!</h2>
    <div class="p-5 bg-gray-800 rounded-2xl font-mono text-xl break-all" id="permanentUrl"></div>
    <button onclick="shareMyLink()" class="w-full py-5 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 rounded-xl font-bold text-xl shadow-lg">
      Share to X, TikTok, Instagram
    </button>
    <div class="flex gap-4 justify-center">
      <a href="/inbox" class="py-3 px-6 bg-purple-600 hover:bg-purple-700 rounded-xl font-bold">Open Inbox</a>
      <button onclick="logout()" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 rounded-xl">Logout</button>
    </div>
  </div>

  <!-- 4. Recording Page (when someone visits /@username) -->
  <div id="recordingPage" class="hidden space-y-8">
    <h2 class="text-4xl font-bold">Drop a voice note to</h2>
    <p class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent" id="targetUsername"></p>

    <div class="space-y-4">
      <select id="character" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
        <option value="0">Blue Robot</option>
        <option value="1">Pink Alien</option>
        <option value="2">Green Monster</option>
        <option value="3">Yellow Blob</option>
      </select>
      <select id="voice" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
        <option value="Kore">Kore (Firm)</option>
        <option value="Puck">Puck (Upbeat)</option>
        <option value="Charon">Charon (Informative)</option>
        <option value="Fenrir">Fenrir (Excitable)</option>
        <option value="Aoede">Aoede (Breezy)</option>
      </select>
    </div>

    <canvas id="characterCanvas" width="300" height="400" class="mx-auto bg-gray-900 rounded-2xl shadow-2xl border-4 border-gray-700"></canvas>

    <div class="flex flex-col items-center gap-4">
      <button id="micBtn" class="w-28 h-28 bg-pink-600 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition">
        <svg class="w-14 h-14" fill="white" viewBox="0 0 24 24">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3s-3 1.34-3 3v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
      </button>
      <p id="status" class="text-lg font-medium text-gray-300">Hold to record your drop</p>
    </div>

    <button onclick="getMyOwnBox()" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 rounded-xl font-bold text-xl">
      Get Your Own Voice Box →
    </button>
  </div>

  <!-- 5. Success after sending -->
  <div id="sentSuccess" class="hidden space-y-10">
    <h2 class="text-5xl font-bold bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">Drop Sent!</h2>
    <p class="text-2xl">They'll get your animated voice message instantly.</p>
    <video id="finalVideo" controls autoplay loop class="w-full rounded-2xl shadow-2xl border-4 border-green-500"></video>
    <button onclick="getMyOwnBox()" class="w-full py-5 bg-gradient-to-r from-pink-500 to-orange-500 rounded-xl font-bold text-xl">
      Get Your Own Box Now
    </button>
  </div>

  <!-- 6. Inbox -->
  <div id="inboxPage" class="hidden space-y-8">
    <div class="flex justify-between items-center">
      <h2 class="text-4xl font-bold">Your Voice Box</h2>
      <button onclick="logout()" class="text-gray-400 underline">Logout</button>
    </div>
    <div id="messagesList" class="space-y-6"></div>
    <p id="noMessages" class="text-gray-500 text-xl hidden">No drops yet.<br>Share your link!</p>
  </div>

</div>

<!-- Message Modal -->
<div id="messageBox" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
  <div class="bg-gray-800 p-8 rounded-2xl max-w-sm w-full space-y-6 border border-purple-500">
    <h3 id="msgTitle" class="text-2xl font-bold"></h3>
    <p id="msgContent" class="text-lg text-gray-300"></p>
    <button onclick="hideMsg()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">OK</button>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const GEMINI_API_KEY = "YOUR_GEMINI_KEY_HERE"; // ← CHANGE THIS!

  // ========= STATE =========
  let currentUsername = null;
  let targetUsername = null;
  let isRecording = false;
  let recorder, stream, analyser, dataArray;

  // ========= CANVAS AVATAR =========
  const canvas = document.getElementById('characterCanvas');
  const ctx = canvas.getContext('2d');
  const characters = [
    { color: "#60a5fa", eyeY: -30 },
    { color: "#f472b6", eyeY: -25 },
    { color: "#34d399", eyeY: -35 },
    { color: "#fbbf24", eyeY: -20 }
  ];

  function drawCharacter(volume = 0) {
    const char = characters[document.getElementById('character')?.value || 0];
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,300,400);
    const scale = 1 + volume * 0.3;

    ctx.save(); ctx.translate(150, 200); ctx.scale(scale, scale);
    ctx.beginPath(); ctx.arc(0, 0, 90, 0, Math.PI*2); ctx.fillStyle = char.color; ctx.fill();
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'black';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    const mouthHeight = 5 + volume * 70;
    ctx.beginPath(); ctx.ellipse(0, 40, 50, mouthHeight, 0, 0, Math.PI * 2); ctx.fillStyle = 'black'; ctx.fill();
    ctx.restore();
  }

  function animate() {
    if (analyser) {
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.slice(0, 16).reduce((a,b)=>a+b)/16 / 255;
      drawCharacter(avg);
    } else drawCharacter();
    requestAnimationFrame(animate);
  }
  animate();

  // ========= PAGE ROUTING =========
  window.onload = () => {
    const path = window.location.pathname;
    if (path === '/' || path === '') showLanding();
    else if (path === '/inbox') checkAuthAndShowInbox();
    else if (path.startsWith('/@')) {
      targetUsername = path.slice(2);
      document.getElementById('targetUsername').textContent = '@' + targetUsername;
      showRecordingPage();
    }
  };

  function showLanding() { hideAll(); document.getElementById('landing').classList.remove('hidden'); }
  function showLogin() { hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); }
  function showRecordingPage() { hideAll(); document.getElementById('recordingPage').classList.remove('hidden'); }
  function showMyLink() { hideAll(); document.getElementById('myLink').classList.remove('hidden'); }
  function showSentSuccess() { hideAll(); document.getElementById('sentSuccess').classList.remove('hidden'); }
  function showInbox() { hideAll(); document.getElementById('inboxPage').classList.remove('hidden'); }
  function hideAll() { document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden')); }

  // ========= AUTH =========
  async function register() {
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    if (!username || !password) return alert('Fill all fields');

    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email, password }),
      credentials: 'include'
    });
    const json = await res.json();
    if (res.ok) {
      currentUsername = username;
      document.getElementById('permanentUrl').textContent = location.origin + '/@' + username;
      showMyLink();
      confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
    } else alert(json.error || 'Error');
  }

  async function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
      credentials: 'include'
    });
    if (res.ok) {
      currentUsername = username;
      window.location = '/inbox';
    } else alert('Wrong credentials');
  }

  async function logout() {
    await fetch('/api/logout', { method: 'POST', credentials: 'include' });
    location.href = '/';
  }

  function shareMyLink() {
    const url = document.getElementById('permanentUrl').textContent;
    if (navigator.share) navigator.share({ title: "My VoxDrop Voice Box", url });
    else navigator.clipboard.writeText(url);
  }

  function getMyOwnBox() { location.href = '/'; }

  // ========= INBOX =========
  async function checkAuthAndShowInbox() {
    const res = await fetch('/api/inbox', { credentials: 'include' });
    if (!res.ok) return location.href = '/';
    const messages = await res.json();
    showInbox();
    const list = document.getElementById('messagesList');
    const noMsg = document.getElementById('noMessages');
    if (messages.length === 0) {
      noMsg.classList.remove('hidden');
      return;
    }
    noMsg.classList.add('hidden');
    list.innerHTML = messages.map(m => `
      <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl">
        <video src="${m.videoUrl}" controls autoplay loop class="w-full rounded-t-2xl"></video>
        <div class="p-4 space-y-3">
          <p class="text-sm text-gray-400">${new Date(m.createdAt).toLocaleString()}</p>
          ${m.transcript ? `<p class="text-gray-300 italic">"${m.transcript}"</p>` : ''}
          <div class="flex gap-3">
            <a href="${m.videoUrl}" download class="flex-1 py-3 bg-green-600 hover:bg-green-700 rounded-xl font-bold">Download</a>
            <button onclick="shareVideo('${m.videoUrl}')" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold">Share</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function shareVideo(url) {
    if (navigator.share) navigator.share({ title: 'VoxDrop', url });
    else navigator.clipboard.writeText(url);
  }

  // ========= RECORDING =========
  const micBtn = document.getElementById('micBtn');
  const statusEl = document.getElementById('status');

  micBtn.onpointerdown = async () => {
    if (isRecording) return;
    try {
      stream = await navigator.mediaDevices.getUserMedia({audio: true});
      const audioCtx = new AudioContext();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);

      recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => processAudio(new Blob(chunks));
      recorder.start();

      isRecording = true;
      micBtn.classList.add('mic-btn-active');
      statusEl.textContent = "Recording... release to send";
    } catch (err) { showMsg("Mic blocked", "Allow microphone to record"); }
  };

  micBtn.onpointerup = micBtn.onpointerleave = () => {
    if (isRecording) {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      isRecording = false;
      micBtn.classList.remove('mic-btn-active');
      statusEl.textContent = "Processing...";
    }
  };

  // ========= GEMINI + VIDEO =========
  async function processAudio(audioBlob) {
    statusEl.textContent = "Transcribing...";
    const b64 = await blobToBase64(audioBlob);
    const text = await transcribe(b64);
    if (!text.trim()) return showMsg("No speech", "Try speaking louder");

    statusEl.textContent = "Synthesizing voice...";
    const synthUrl = await synthesize(text, document.getElementById('voice').value);

    statusEl.textContent = "Rendering video...";
    const videoBlob = await createFinalVideo(synthUrl);

    await sendToUser(videoBlob, text);
  }

  async function sendToUser(videoBlob, transcript) {
    const form = new FormData();
    form.append('video', videoBlob, 'voxdrop.webm');
    form.append('transcript', transcript);
    form.append('character', document.getElementById('character').value);
    form.append('voice', document.getElementById('voice').value);

    const res = await fetch(`/api/receive/${targetUsername}`, {
      method: 'POST',
      body: form
    });

    if (res.ok) {
      document.getElementById('finalVideo').src = URL.createObjectURL(videoBlob);
      showSentSuccess();
      confetti({ particleCount: 300, spread: 100 });
    } else {
      showMsg("Error", "Failed to send. Try again.");
    }
  }

  // ========= GEMINI FUNCTIONS =========
  async function transcribe(b64) {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [
          { text: "Transcribe exactly. No extra words." },
          { inlineData: { mimeType: "audio/webm", data: b64 }}
        ]}]
      })
    });
    const json = await res.json();
    return json.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
  }

  async function synthesize(text, voiceName) {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text }] }],
        generationConfig: { responseModalities: ["AUDIO"] },
        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
      })
    });
    const json = await res.json();
    const data = json.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
    if (!data) throw new Error("TTS failed");
    const rate = 24000; // Default
    const wavBlob = pcmToWav(base64ToArrayBuffer(data), rate);
    return URL.createObjectURL(wavBlob);
  }

  async function createFinalVideo(audioUrl) {
    const audio = new Audio(audioUrl);
    const ctx = new AudioContext();
    const dest = ctx.createMediaStreamDestination();
    const source = ctx.createMediaElementSource(audio);
    const analyser2 = ctx.createAnalyser();
    analyser2.fftSize = 512;
    dataArray = new Uint8Array(analyser2.frequencyBinCount);
    analyser = analyser2;

    source.connect(analyser2);
    analyser2.connect(dest);
    analyser2.connect(ctx.destination);

    const canvasStream = canvas.captureStream(30);
    const combined = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
    const rec = new MediaRecorder(combined, {mimeType: 'video/webm;codecs=vp9,opus'});
    const chunks = [];

    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = () => {
      analyser = null;
      dataArray = null;
    };

    audio.play();
    rec.start();
    audio.onended = () => setTimeout(() => rec.stop(), 1000);

    return new Promise(resolve => rec.onstop = () => resolve(new Blob(chunks, {type: 'video/webm'})));
  }

  function blobToBase64(blob) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.onerror = rej;
      reader.readAsDataURL(blob);
    });
  }

  function base64ToArrayBuffer(b64) {
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return arr.buffer;
  }

  function pcmToWav(pcmBuffer, sampleRate) {
    const buffer = new ArrayBuffer(44 + pcmBuffer.byteLength);
    const view = new DataView(buffer);
    const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
    const pcm16 = new Int16Array(pcmBuffer);
    writeString(0, 'RIFF');
    view.setUint32(4, 36 + pcm16.length * 2, true);
    writeString(8, 'WAVEfmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, pcm16.length * 2, true);
    let offset = 44;
    for (let i = 0; i < pcm16.length; i++, offset += 2) view.setInt16(offset, pcm16[i], true);
    return new Blob([buffer], {type: 'audio/wav'});
  }

  function showMsg(title, content) {
    document.getElementById('msgTitle').textContent = title;
    document.getElementById('msgContent').textContent = content;
    document.getElementById('messageBox').classList.remove('hidden');
  }
  function hideMsg() { document.getElementById('messageBox').classList.add('hidden'); }
</script>
</body>
</html>
