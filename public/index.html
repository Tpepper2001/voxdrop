<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoxDrop – Your Anonymous Voice Box</title>
  <meta property="og:title" content="You got a VoxDrop!" />
  <meta property="og:description" content="Someone sent you an anonymous animated voice message." />
  <meta name="twitter:card" content="player" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; }
    .mic-btn-active { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
  </style>
</head>
<body class="min-h-screen">

<div id="app" class="max-w-lg mx-auto p-6 text-center">

  <!-- Landing / Register -->
  <div id="landing" class="space-y-10">
    <h1 class="text-6xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent">VoxDrop</h1>
    <p class="text-xl text-gray-300">Get your own anonymous voice box</p>
    <div class="space-y-4">
      <input id="username" placeholder="Choose username" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <button onclick="register()" class="w-full py-5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-xl shadow-lg">
        Create My Box
      </button>
    </div>
  </div>

  <!-- Your Link After Register -->
  <div id="myLink" class="hidden space-y-10">
    <h2 class="text-5xl font-bold bg-gradient-to-r from-green-400 to-cyan-400 bg-clip-text text-transparent">Ready!</h2>
    <div id="shareUrl" class="p-5 bg-gray-800 rounded-2xl font-mono text-xl break-all"></div>
    <button onclick="shareLink()" class="w-full py-5 bg-gradient-to-r from-pink-500 to-orange-500 rounded-xl font-bold text-xl">
      Share to X, TikTok, Instagram
    </button>
    <a href="/inbox" class="block py-4 bg-purple-600 hover:bg-purple-700 rounded-xl font-bold text-xl">Open Inbox</a>
  </div>

  <!-- Recording Page (@username) -->
  <div id="recording" class="hidden space-y-8">
    <h2 class="text-4xl font-bold">Drop a voice to</h2>
    <p class="text-5xl font-black bg-gradient-to-r from-pink-400 to-blue-400 bg-clip-text text-transparent" id="targetName"></p>

    <select id="character" class="p-4 rounded-xl bg-gray-800 text-white w-full text-lg">
      <option value="0">Blue Robot</option>
      <option value="1">Pink Alien</option>
      <option value="2">Green Monster</option>
      <option value="3">Yellow Blob</option>
    </select>

    <canvas id="canvas" width="300" height="400" class="mx-auto bg-gray-900 rounded-2xl shadow-2xl border-4 border-gray-700"></canvas>

    <button id="micBtn" class="w-28 h-28 bg-pink-600 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition">
      <svg class="w-14 h-14" fill="white" viewBox="0 0 24 24">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3s-3 1.34-3 3v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
      </svg>
    </button>
    <p id="status" class="text-lg text-gray-300">Hold to record</p>

    <button onclick="location.href='/'" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-bold text-xl">
      Get Your Own Box
    </button>
  </div>

  <!-- Inbox -->
  <div id="inbox" class="hidden space-y-8">
    <h2 class="text-4xl font-bold">Your Voice Box</h2>
    <div id="messages" class="space-y-6"></div>
    <p id="empty" class="text-gray-500 text-xl hidden">No drops yet — share your link!</p>
  </div>

</div>

<script>
  const GEMINI_API_KEY = "AIzaSyBEcPWeIY5neitnrEofI2bWLtkiRTtAIPI"; // ← CHANGE THIS!

  let targetUsername = null;
  let currentUsername = null;
  let isRecording = false;
  let recorder, stream;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const characters = [
    { color: "#60a5fa", eyeY: -30 },
    { color: "#f472b6", eyeY: -25 },
    { color: "#34d399", eyeY: -35 },
    { color: "#fbbf24", eyeY: -20 }
  ];

  function draw(volume = 0) {
    const char = characters[document.getElementById('character')?.value || 0];
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,300,400);
    const scale = 1 + volume * 0.3;
    ctx.save(); ctx.translate(150, 200); ctx.scale(scale, scale);
    ctx.beginPath(); ctx.arc(0, 0, 90, 0, Math.PI*2); ctx.fillStyle = char.color; ctx.fill();
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 20, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'black';
    ctx.beginPath(); ctx.arc(-35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(35, char.eyeY, 10, 0, Math.PI*2); ctx.fill();
    const mouth = 5 + volume * 70;
    ctx.beginPath(); ctx.ellipse(0, 40, 50, mouth, 0, 0, Math.PI*2); ctx.fillStyle = 'black'; ctx.fill();
    ctx.restore();
  }
  function animate() { draw(); requestAnimationFrame(animate); }
  animate();

  window.onload = () => {
    const path = location.pathname;
    if (path === '/' || path === '') document.getElementById('landing').classList.remove('hidden');
    else if (path === '/inbox') loadInbox();
    else if (path.startsWith('/@')) {
      targetUsername = path.slice(2);
      document.getElementById('targetName').textContent = '@' + targetUsername;
      document.getElementById('recording').classList.remove('hidden');
    }
  };

  async function register() {
    const username = document.getElementById('username').value.trim();
    if (!username) return alert("Enter username");
    const res = await fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username}) });
    if (res.ok) {
      currentUsername = username;
      document.getElementById('shareUrl').textContent = location.origin + '/@' + username;
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('myLink').classList.remove('hidden');
      confetti({particleCount: 200, spread: 70});
    } else alert("Username taken");
  }

  function shareLink() {
    const url = document.getElementById('shareUrl').textContent;
    if (navigator.share) navigator.share({title: "My VoxDrop", url});
    else navigator.clipboard.writeText(url);
  }

  async function loadInbox() {
    if (!currentUsername) { location.href = '/'; return; }
    const res = await fetch('/api/inbox/' + currentUsername);
    const messages = await res.json();
    document.getElementById('inbox').classList.remove('hidden');
    const list = document.getElementById('messages');
    if (messages.length === 0) {
      document.getElementById('empty').classList.remove('hidden');
      return;
    }
    list.innerHTML = messages.map(m => `
      <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl">
        <video src="${m.videoUrl}" controls autoplay loop class="w-full"></video>
        <div class="p-4">
          ${m.transcript ? `<p class="text-gray-300 italic">"${m.transcript}"</p>` : ''}
          <div class="flex gap-3 mt-3">
            <a href="${m.videoUrl}" download class="flex-1 py-3 bg-green-600 rounded-xl font-bold">Download</a>
            <button onclick="navigator.clipboard.writeText('${m.videoUrl}')" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">Copy Link</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Recording
  const micBtn = document.getElementById('micBtn');
  micBtn.onpointerdown = async () => {
    if (isRecording) return;
    try {
      stream = await navigator.mediaDevices.getUserMedia({audio: true});
      recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => processAudio(new Blob(chunks));
      recorder.start();
      isRecording = true;
      micBtn.classList.add('mic-btn-active');
      document.getElementById('status').textContent = "Recording...";
    } catch (e) { alert("Mic blocked"); }
  };
  micBtn.onpointerup = micBtn.onpointerleave = () => {
    if (isRecording) {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      isRecording = false;
      micBtn.classList.remove('mic-btn-active');
      document.getElementById('status').textContent = "Processing...";
    }
  };

  async function processAudio(blob) {
    try {
      const b64 = await blobToBase64(blob);
      const text = await transcribe(b64);
      const audioUrl = await synthesize(text);
      const videoBlob = await renderVideo(audioUrl);
      await send(videoBlob, text);
    } catch (err) {
      console.error('Processing error:', err);
      document.getElementById('status').textContent = "Error: " + err.message;
      alert("Error processing: " + err.message);
    }
  }

  async function send(videoBlob, transcript) {
    const form = new FormData();
    form.append('video', videoBlob, 'drop.webm');
    form.append('transcript', transcript);
    const res = await fetch(`/api/receive/${targetUsername}`, { method: 'POST', body: form });
    if (res.ok) {
      alert("Drop sent! Get your own box?");
      location.href = '/';
    } else {
      alert("Failed to send drop");
    }
  }

  async function transcribe(b64) {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST", headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ contents: [{ parts: [{text: "Transcribe this audio exactly."}, {inlineData: {mimeType: "audio/webm", data: b64}}]}]})
    });
    const json = await res.json();
    if (json.error) throw new Error(json.error.message);
    return json.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
  }

  async function synthesize(text) {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST", headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ 
        contents: [{ parts: [{text}] }], 
        generationConfig: {responseModalities: ["AUDIO"]}
      })
    });
    const json = await res.json();
    if (json.error) throw new Error(json.error.message);
    const data = json.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
    if (!data) throw new Error("No audio in response");
    const binaryStr = atob(data);
    const bytes = new Uint8Array(binaryStr.length);
    for (let i = 0; i < binaryStr.length; i++) bytes[i] = binaryStr.charCodeAt(i);
    const wav = pcmToWav(bytes, 24000);
    return URL.createObjectURL(wav);
  }

  async function renderVideo(audioUrl) {
    return new Promise((resolve, reject) => {
      const audio = new Audio(audioUrl);
      const mediaStream = canvas.captureStream(30);
      const rec = new MediaRecorder(mediaStream);
      const chunks = [];
      
      rec.ondataavailable = e => chunks.push(e.data);
      rec.onstop = () => {
        resolve(new Blob(chunks, {type: 'video/webm'}));
      };
      
      audio.onplay = () => rec.start();
      audio.onended = () => {
        setTimeout(() => rec.stop(), 500);
      };
      audio.onerror = (e) => reject(new Error("Audio error: " + e));
      
      audio.play().catch(err => reject(new Error("Play failed: " + err)));
    });
  }

  function blobToBase64(b) { 
    return new Promise((r) => {
      const a = new FileReader(); 
      a.onload = () => r(a.result.split(',')[1]); 
      a.readAsDataURL(b);
    }); 
  }

  function pcmToWav(pcm, rate) {
    const buffer = new ArrayBuffer(44 + pcm.byteLength);
    const view = new DataView(buffer);
    const write = (o, s) => {
      for(let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i));
    };
    write(0, 'RIFF'); 
    view.setUint32(4, 36 + pcm.byteLength, true); 
    write(8, 'WAVEfmt '); 
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); 
    view.setUint16(22, 1, true); 
    view.setUint32(24, rate, true); 
    view.setUint32(28, rate * 2, true);
    view.setUint16(32, 2, true); 
    view.setUint16(34, 16, true); 
    write(36, 'data'); 
    view.setUint32(40, pcm.byteLength, true);
    return new Blob([buffer], {type:'audio/wav'});
  }
</script>
</body>
</html>
